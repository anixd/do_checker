<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Geo Catalog</title>
  <link rel="shortcut icon" href="{{ url_for('static', filename='img/do.ico') }}">
  <style>
    /* базовые стили */
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; max-width: 960px; }
    h2, h3, h4 { margin-top: 1.5em; }
    .muted { color:#666; font-size:12px; }
    button {
        padding: 8px 16px;
        background: #007aff;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 1em;
    }
    button:hover { background: #0056b3; }

    /* табы */
    nav.tabs {
        border-bottom: 2px solid #ddd;
        margin-bottom: 20px;
    }
    nav.tabs a {
        display: inline-block;
        padding: 8px 16px;
        text-decoration: none;
        color: #333;
        border: 2px solid transparent;
        border-bottom: none;
        border-radius: 6px 6px 0 0;
        font-weight: 500;
        position: relative;
        top: 2px;
    }
    nav.tabs a:hover { background-color: #f0f0f0; }
    nav.tabs a.active {
        border-color: #08244e;
        background-color: #72b2e2;
    }

    .catalog-meta {
        background-color: #f8f8f8;
        border: 1px solid #ddd;
        padding: 10px 15px;
        border-radius: 6px;
        margin-bottom: 20px;
        font-size: 14px;
    }

    /* спойлеры */
    details {
        border: 1px solid #ccc;
        border-radius: 8px;
        margin-bottom: 12px;
        background-color: #fff;
    }
    summary {
        padding: 12px 16px;
        font-weight: bold;
        cursor: pointer;
        list-style: none;
        display: flex;
        align-items: center;
        border-bottom: 1px solid transparent;
    }
    details[open] summary {
        border-bottom-color: #eee;
    }
    summary::before {
        content: '▶';
        margin-right: 10px;
        font-size: 0.8em;
        transition: transform 0.2s;
    }
    details[open] summary::before {
        transform: rotate(90deg);
    }
    .details-content {
        padding: 0 16px 16px 36px;
    }

    /* списки внутри спойлера */
    .details-content h4 {
        margin-top: 1em;
        margin-bottom: 0.5em;
    }
    .geo-list {
        list-style: none;
        padding-left: 0;
        margin-bottom: 1em;
        margin-top: 0;
    }
    .geo-list li {
        background-color: #f0f0f0;
        padding: 4px 8px;
        border-radius: 4px;
        margin-bottom: 4px;
        display: inline-block;
        margin-right: 6px;
        font-size: 13px;
    }
    .geo-list li code {
        background-color: #e0e0e0;
        padding: 1px 4px;
        border-radius: 3px;
        margin-right: 5px;
        font-size: 12px;
    }
    .empty-list {
        color: #888;
        font-style: italic;
        font-size: 13px;
        margin-top: 0;
    }

    /* Flash сообщения */
    .flash-message {
        padding: 12px 16px;
        margin-bottom: 16px;
        border: 1px solid transparent;
        border-radius: 6px;
        font-size: 14px;
    }
    .flash-info { /* Категория 'info' */
        color: #0c5460;
        background-color: #d1ecf1;
        border-color: #bee5eb;
    }
    .flash-error { /* На будущее */
        color: #721c24;
        background-color: #f8d7da;
        border-color: #f5c6cb;
    }
    .flash-success { /* На будущее */
        color: #155724;
        background-color: #d4edda;
        border-color: #c3e6cb;
    }

    /* Utility classes */
    .mb-1 { margin-bottom: 8px; }
    .mb-2 { margin-bottom: 16px; }
    .mb-3 { margin-bottom: 24px; }
    .mt-1 { margin-top: 8px; }
    .mt-2 { margin-top: 16px; }
    .mt-3 { margin-top: 24px; }
    .text-danger { color: #dc3545; font-weight: bold; }

    /* Стили для новой формы */
    fieldset { border: 1px solid #ccc; border-radius: 8px; margin-bottom: 16px; padding: 16px;}
    legend { font-weight: bold; padding: 0 8px; }
    .form-group { display: flex; flex-direction: column; }
    input[type="text"] {
        padding: 6px 8px;
        border-radius: 4px;
        border: 1px solid #aaa;
        min-width: 150px;
        font-size: 14px;
    }
    label.checkbox-label {
        display: block;
        margin-bottom: 5px;
        font-weight: normal;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
    }
    label.checkbox-label:hover {
        background-color: #f0f0f0;
    }
    label.checkbox-label input {
        margin-right: 8px;
    }
    label.checkbox-label code {
        background-color: #e0e0e0;
        padding: 2px 5px;
        border-radius: 3px;
        font-size: 1.05em;
    }
  </style>
</head>
<body>

  <nav class="tabs">
    <a href="{{ url_for('routes.index') }}">Checker</a>
    <a href="{{ url_for('routes.catalog') }}" class="active">Geo Catalog</a>
    <a href="{{ url_for('routes.settings') }}" target="_blank" rel="noopener noreferrer">Settings</a>
  </nav>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash-message flash-{{ category or 'default' }}" role="alert">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <h2 class="mb-2">SOAX Geo Catalog</h2>

  <div class="catalog-meta mb-2">
    Version: {{ catalog.version | default('N/A') }} <br>
    Generated At: {{ catalog.generated_at | default('N/A') }}
  </div>

  {% set countries_list = catalog.countries | sort(attribute='name') %}

  <form method="post" action="{{ url_for('routes.catalog_update_list') }}" class="mb-3">
    <fieldset>
        <legend>Manage Country List</legend>

        <div class="form-group mb-2">
            <label for="new_countries" style="font-weight: 500; margin-bottom: 4px;">
              Add new countries (ISO-2 codes, space-separated)
            </label>
            <input type="text" name="new_countries" id="new_countries" placeholder="ua fr de" style="width: 100%; box-sizing: border-box;">
        </div>

        <details open>
            <summary style="font-weight: 500;">Keep/Remove existing countries ({{ countries_list|length }})</summary>
            <div class="form-group" style="padding: 10px 0 0 10px; max-height: 250px; overflow-y: auto; border-top: 1px solid #eee; margin-top: 10px;">
                {% if countries_list %}
                    {% for c in countries_list %}
                    <label class="checkbox-label">
                        <input type="checkbox" name="countries_to_keep" value="{{ c.code }}" checked>
                        <code>{{ c.code | upper }}</code> — {{ c.name }}
                    </label>
                    {% endfor %}
                {% else %}
                    <p class="muted">List is empty. Add countries using the field above.</p>
                {% endif %}
            </div>
        </details>
    </fieldset>

    <button type="submit">Save List Changes</button>
  </form>

  <hr style="margin: 24px 0;">

  <h3 style="margin-top: 0;">Refresh Data from SOAX API</h3>
  <p class="muted" style="margin-top: -10px; margin-bottom: 10px;">
    This will fetch new Regions, Cities, and ISPs for the countries saved in the list above.
  </p>
  <form method="post" action="{{ url_for('routes.catalog_refresh') }}" class="mb-3">
    <button type="submit">Refresh from SOAX (in background)</button>
  </form>

  <hr style="margin: 24px 0;">

  <h3>Catalog Viewer</h3>
  {% if countries_list %}
    {% for country in countries_list %}
      <details>
        <summary>{{ country.code | upper }} — {{ country.name }}</summary>
        <div class="details-content">
          <h4>Regions</h4>
          {% if country.regions %}
            <ul class="geo-list">
              {% for region in country.regions | sort(attribute='name') %}
                <li><code>{{ region.code }}</code> {{ region.name }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="empty-list">(No regions listed)</p>
          {% endif %}

          <h4>Cities</h4>
          {% if country.cities %}
            <ul class="geo-list">
              {% for city in country.cities | sort(attribute='name') %}
                <li><code>{{ city.code }}</code> {{ city.name }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="empty-list">(No cities listed)</p>
          {% endif %}

          <h4>ISPs</h4>
          {% if country.isps %}
            <ul class="geo-list">
              {% for isp in country.isps | sort %}
                <li>{{ isp }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="empty-list">(No ISPs listed)</p>
          {% endif %}
        </div>
      </details>
    {% endfor %}
  {% else %}
    <p class="muted">Catalog is empty or could not be loaded.</p>
  {% endif %}

</body>
</html>
