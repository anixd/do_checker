{% extends "base.html" %}

{% block content %}
  <h2 class="mb-2">SOAX Geo Catalog</h2>

  <div class="catalog-meta mb-2">
    Version: {{ catalog.version | default('N/A') }} <br>
    Generated At: {{ catalog.generated_at | default('N/A') }}
  </div>

  {% set countries_list = catalog.countries | sort(attribute='name') %}

  <form method="post" action="{{ url_for('routes.catalog_update_list') }}" class="mb-3">
    <fieldset>
        <legend>Manage Country List</legend>

        <div class="form-group mb-2">
            <label for="new_countries" style="font-weight: 500; margin-bottom: 4px;">
              Add new countries (ISO-2 codes, space-separated)
            </label>
            <input type="text" name="new_countries" id="new_countries" placeholder="ua fr de" style="width: 100%; box-sizing: border-box;">
        </div>

        <details open>
            <summary style="font-weight: 500;">Keep/Remove existing countries ({{ countries_list|length }})</summary>
            <div class="form-group" style="padding: 10px 0 0 10px; max-height: 250px; overflow-y: auto; border-top: 1px solid #eee; margin-top: 10px;">
                {% if countries_list %}
                    {% for c in countries_list %}
                    <label class="checkbox-label">
                        <input type="checkbox" name="countries_to_keep" value="{{ c.code }}" checked>
                        <code>{{ c.code | upper }}</code> — {{ c.name }}
                    </label>
                    {% endfor %}
                {% else %}
                    <p class="muted">List is empty. Add countries using the field above.</p>
                {% endif %}
            </div>
        </details>
    </fieldset>

    <button type="submit">Save List Changes</button>
  </form>

  <hr style="margin: 24px 0;">

  <h3 style="margin-top: 0;">Refresh Data from SOAX API</h3>
  <p class="muted" style="margin-top: -10px; margin-bottom: 10px;">
    This will fetch new Regions, Cities, and ISPs for the countries saved in the list above.
  </p>
  <form method="post" action="{{ url_for('routes.catalog_refresh') }}" class="mb-3">
    <button type="submit">Refresh from SOAX (in background)</button>
  </form>

  <hr style="margin: 24px 0;">

  <h3>Catalog Viewer</h3>
  {% if countries_list %}
    {% for country in countries_list %}
      <details>
        <summary>{{ country.code | upper }} — {{ country.name }}</summary>
        <div class="details-content">
          <h4>Regions</h4>
          {% if country.regions %}
            <ul class="geo-list">
              {% for region in country.regions | sort(attribute='name') %}
                <li><code>{{ region.code }}</code> {{ region.name }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="empty-list">(No regions listed)</p>
          {% endif %}

          <h4>Cities</h4>
          {% if country.cities %}
            <ul class="geo-list">
              {% for city in country.cities | sort(attribute='name') %}
                <li><code>{{ city.code }}</code> {{ city.name }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="empty-list">(No cities listed)</p>
          {% endif %}

          <h4>ISPs</h4>
          {% if country.isps %}
            <ul class="geo-list">
              {% for isp in country.isps | sort %}
                <li>{{ isp }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="empty-list">(No ISPs listed)</p>
          {% endif %}
        </div>
      </details>
    {% endfor %}
  {% else %}
    <p class="muted">Catalog is empty or could not be loaded.</p>
  {% endif %}
{% endblock %}
